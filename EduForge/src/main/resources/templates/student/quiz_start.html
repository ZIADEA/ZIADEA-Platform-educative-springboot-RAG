<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(${pageTitle}, ~{::content})}">
<div th:fragment="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0">Démarrer un quiz</h2>
    <a class="btn btn-outline-secondary btn-sm" th:href="@{|/course/${course.id}|}">Retour au cours</a>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="fw-semibold" th:text="${course.title}"></div>
      <div class="text-muted small" th:if="${course.description != null}" th:text="${course.description}"></div>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form th:action="@{|/student/quiz/start/${course.id}|}" th:object="${form}" method="post" class="row g-3">
        <div class="col-12">
          <label class="form-label">Sujet du quiz (optionnel)</label>
          <input class="form-control" th:field="*{query}" placeholder="Ex: sécurité Spring, JWT, RAG, etc.">
          <div class="small text-muted mt-1">Si vide : quiz basé sur les points importants du cours.</div>
        </div>
        
        <div class="col-12 col-md-4">
          <label class="form-label">Nombre de questions</label>
          <select class="form-select" th:field="*{questionCount}">
            <option value="">Auto (adaptatif)</option>
            <option value="5">5 questions</option>
            <option value="8">8 questions</option>
            <option value="10">10 questions</option>
            <option value="15">15 questions</option>
            <option value="20">20 questions</option>
          </select>
          <div class="small text-muted">Le mode auto ajuste selon tes résultats.</div>
        </div>
        
        <div class="col-12 col-md-4">
          <label class="form-label">Questions ouvertes</label>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" th:field="*{includeOpenEnded}" id="includeOpenEnded">
            <label class="form-check-label" for="includeOpenEnded">
              Inclure des questions ouvertes (corrigées par IA)
            </label>
          </div>
          <select class="form-select" th:field="*{openEndedCount}" id="openEndedCount">
            <option value="0">0</option>
            <option value="1">1 question ouverte</option>
            <option value="2">2 questions ouvertes</option>
            <option value="3">3 questions ouvertes</option>
            <option value="5">5 questions ouvertes</option>
          </select>
        </div>
        
        <div class="col-12 col-md-4 d-flex align-items-end">
          <button class="btn btn-primary w-100">
            <i class="bi bi-lightning-charge me-1"></i>Générer le quiz
          </button>
        </div>
      </form>
      
      <div class="alert alert-info mt-3 mb-0 small">
        <i class="bi bi-info-circle me-1"></i>
        <strong>Quiz adaptatif:</strong> Le système ajuste la difficulté selon tes performances.
        Plus tu réussis, plus les questions sont difficiles !
      </div>
      
      <div class="small text-muted mt-2">
        Si la génération échoue : demande au prof d'indexer (RAG).
      </div>
    </div>
  </div>
  
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
      const checkbox = document.getElementById('includeOpenEnded');
      const select = document.getElementById('openEndedCount');
      
      function toggleSelect() {
        select.disabled = !checkbox.checked;
        if (!checkbox.checked) select.value = '0';
      }
      
      checkbox.addEventListener('change', toggleSelect);
      toggleSelect();
    });
  </script>

  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="h6">Historique</h3>
      <div th:if="${#lists.isEmpty(history)}" class="text-muted">Aucune tentative.</div>
      <div th:if="${!#lists.isEmpty(history)}" class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr><th>Date</th><th>Score</th><th>Statut</th></tr>
          </thead>
          <tbody>
            <tr th:each="a: ${history}">
              <td th:text="${#temporals.format(a.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
              <td th:text="${a.scorePercent + '% (' + a.correctCount + '/' + a.totalCount + ')'}"></td>
              <td>
                <span class="badge" th:classappend="${a.status.name()=='PASSED'?'text-bg-success':'text-bg-danger'}"
                      th:text="${a.status}"></span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</html>
