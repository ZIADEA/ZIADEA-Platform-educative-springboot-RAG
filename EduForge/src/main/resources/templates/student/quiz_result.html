<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(${pageTitle}, ~{::content})}">
<div th:fragment="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0">Résultat</h2>
    <a class="btn btn-outline-secondary btn-sm" th:href="@{|/student/quiz/start/${course.id}|}">Nouveau quiz</a>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="fw-semibold" th:text="${course.title}"></div>

      <div class="mt-2">
        <span class="badge"
              th:classappend="${attempt.status.name()=='PASSED'?'text-bg-success':'text-bg-danger'}"
              th:text="${attempt.status.name()=='PASSED'?'✓ Réussi':'✗ Échoué'}"></span>
        <span class="ms-2 fw-semibold fs-4" th:text="${attempt.scorePercent + '%'}"></span>
        <span class="text-muted ms-2" th:text="${'(' + attempt.correctCount + '/' + attempt.totalCount + ') — Seuil: ' + threshold + '%'}"></span>
      </div>

      <!-- Suggestion personnalisée -->
      <div th:if="${suggestion != null}" class="alert alert-info mt-3 mb-0">
        <strong th:text="${suggestion.level()}">Niveau</strong>
        <p class="mb-0 mt-1" th:text="${suggestion.suggestion()}">Conseil</p>
      </div>
    </div>
  </div>

  <!-- Feedback pédagogique si échec -->
  <div th:if="${feedback != null && !feedback.isEmpty()}" class="card shadow-sm mb-3 border-warning">
    <div class="card-header bg-warning bg-opacity-10">
      <i class="bi bi-lightbulb me-2"></i><strong>Feedback personnalisé pour t'aider</strong>
    </div>
    <div class="card-body">
      <p class="mb-0" th:text="${feedback}" style="white-space: pre-wrap;"></p>
    </div>
  </div>

  <!-- Bouton régénération adaptative si échec -->
  <div th:if="${attempt.status.name()=='FAILED'}" class="card shadow-sm mb-3 border-primary">
    <div class="card-body text-center py-4">
      <i class="bi bi-arrow-repeat fs-1 text-primary d-block mb-3"></i>
      <h5 class="mb-3">Tu as des difficultés ?</h5>
      <p class="text-muted mb-3">
        Génère un nouveau quiz plus facile, ciblé sur les points qui t'ont posé problème !
      </p>
      <form th:action="@{/student/quiz/regenerate/{id}(id=${attempt.id})}" method="post" class="d-inline">
        <button type="submit" class="btn btn-primary btn-lg">
          <i class="bi bi-magic me-2"></i>Générer un quiz adapté
        </button>
      </form>
    </div>
  </div>

  <!-- Détail des questions -->
  <h5 class="mb-3">Détail de tes réponses</h5>
  <div class="card shadow-sm mb-3" th:each="q : ${questions}">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div class="fw-semibold flex-grow-1">
          <span class="badge bg-secondary me-2" th:text="${'Q' + q.index}">Q1</span>
          <span th:text="${q.questionText}">Question</span>
        </div>
        <span th:if="${answersByQ[q.id] != null && answersByQ[q.id].isCorrect}" class="badge bg-success">
          <i class="bi bi-check-circle"></i> Correct
        </span>
        <span th:unless="${answersByQ[q.id] != null && answersByQ[q.id].isCorrect}" class="badge bg-danger">
          <i class="bi bi-x-circle"></i> Incorrect
        </span>
      </div>

      <div class="mt-3">
        <div class="row">
          <div class="col-md-6">
            <strong>Ta réponse:</strong>
            <span th:classappend="${answersByQ[q.id] != null && answersByQ[q.id].isCorrect ? 'text-success' : 'text-danger'}"
                  th:text="${answersByQ[q.id] != null ? answersByQ[q.id].chosenChoice : '-'}">A</span>
          </div>
          <div class="col-md-6">
            <strong>Bonne réponse:</strong>
            <span class="text-success" th:text="${q.correctChoice}">B</span>
          </div>
        </div>
        <div class="mt-2 p-2 bg-light rounded">
          <i class="bi bi-info-circle me-1"></i>
          <strong>Explication:</strong>
          <span th:text="${q.explanation}">Explication</span>
        </div>
      </div>

    </div>
  </div>

  <!-- Actions finales -->
  <div class="d-flex gap-2 mt-4">
    <a th:href="@{/student/quiz/start/{id}(id=${course.id})}" class="btn btn-primary">
      <i class="bi bi-arrow-clockwise me-1"></i>Nouveau quiz
    </a>
    <a th:href="@{/course/{id}(id=${course.id})}" class="btn btn-outline-secondary">
      <i class="bi bi-book me-1"></i>Retour au cours
    </a>
  </div>

</div>
</html>
