<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(${pageTitle}, ~{::content})}">
<div th:fragment="content">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a th:href="@{/prof/exam}">Examens</a></li>
      <li class="breadcrumb-item active" th:text="${exam.title}">Examen</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1" th:text="${exam.title}">Titre</h1>
      <span th:switch="${exam.status.name()}">
        <span th:case="'DRAFT'" class="badge bg-secondary">Brouillon</span>
        <span th:case="'PUBLISHED'" class="badge bg-success">Publié</span>
        <span th:case="'CLOSED'" class="badge bg-danger">Fermé</span>
      </span>
    </div>
    <div class="d-flex gap-2">
      <a th:href="@{/prof/exam/{id}/edit(id=${exam.id})}" class="btn btn-outline-primary"
         th:if="${exam.status.name() == 'DRAFT'}">
        <i class="bi bi-pencil me-2"></i>Modifier
      </a>
      <form th:action="@{/prof/exam/{id}/publish(id=${exam.id})}" method="post" 
            th:if="${exam.status.name() == 'DRAFT'}" class="d-inline">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-send me-2"></i>Publier
        </button>
      </form>
      <form th:action="@{/prof/exam/{id}/close(id=${exam.id})}" method="post" 
            th:if="${exam.status.name() == 'PUBLISHED'}" class="d-inline">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-x-circle me-2"></i>Fermer
        </button>
      </form>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <!-- Informations de l'examen -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-info-circle me-2"></i>Informations
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <strong>Type:</strong>
              <span th:switch="${exam.examType.name()}">
                <span th:case="'QUIZ'">Quiz rapide</span>
                <span th:case="'MIDTERM'">Examen partiel</span>
                <span th:case="'FINAL'">Examen final</span>
                <span th:case="'PRACTICE'">Pratique</span>
              </span>
            </div>
            <div class="col-md-4">
              <strong>Questions:</strong> <span th:text="${exam.questionCount}">10</span>
            </div>
            <div class="col-md-4">
              <strong>Durée:</strong> <span th:text="${exam.durationMinutes}">60</span> min
            </div>
            <div class="col-md-4">
              <strong>Seuil de réussite:</strong> <span th:text="${exam.passThreshold}">50</span>%
            </div>
            <div class="col-md-4">
              <strong>Max tentatives:</strong> <span th:text="${exam.maxAttempts}">1</span>
            </div>
            <div class="col-md-4" th:if="${exam.isScheduled}">
              <strong>Programmé:</strong>
              <span th:text="${#temporals.format(exam.scheduledStart, 'dd/MM HH:mm')}">Date</span>
            </div>
          </div>
          <p class="mt-3 mb-0 text-muted" th:if="${exam.description}" th:text="${exam.description}">Description</p>
        </div>
      </div>

      <!-- Liste des questions -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="bi bi-list-ol me-2"></i>Questions (<span th:text="${#lists.size(questions)}">0</span>)</span>
        </div>
        <div class="card-body" th:if="${#lists.isEmpty(questions)}">
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Aucune question. Retournez à l'édition pour générer les questions via l'IA.
          </div>
        </div>
        <ul class="list-group list-group-flush" th:unless="${#lists.isEmpty(questions)}">
          <li class="list-group-item" th:each="q, idx : ${questions}">
            <div class="d-flex justify-content-between">
              <strong class="text-primary">Q<span th:text="${idx.count}">1</span>.</strong>
              <span class="badge bg-success" th:text="'Rép: ' + ${q.correctChoice}">A</span>
            </div>
            <p class="mb-2" th:text="${q.questionText}">Question</p>
            <div class="row small">
              <div class="col-6 col-md-3" th:classappend="${q.correctChoice == 'A' ? 'text-success fw-bold' : ''}">
                <strong>A)</strong> <span th:text="${q.aText}">Choix A</span>
              </div>
              <div class="col-6 col-md-3" th:classappend="${q.correctChoice == 'B' ? 'text-success fw-bold' : ''}">
                <strong>B)</strong> <span th:text="${q.bText}">Choix B</span>
              </div>
              <div class="col-6 col-md-3" th:classappend="${q.correctChoice == 'C' ? 'text-success fw-bold' : ''}">
                <strong>C)</strong> <span th:text="${q.cText}">Choix C</span>
              </div>
              <div class="col-6 col-md-3" th:classappend="${q.correctChoice == 'D' ? 'text-success fw-bold' : ''}">
                <strong>D)</strong> <span th:text="${q.dText}">Choix D</span>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <div class="col-md-4">
      <!-- Statistiques -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-graph-up me-2"></i>Statistiques
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <h4 th:text="${stats != null ? stats.totalAttempts() : 0}">0</h4>
              <small class="text-muted">Tentatives</small>
            </div>
            <div class="col-6 mb-3">
              <h4 th:text="${stats != null ? #numbers.formatDecimal(stats.averageScore(), 1, 1) : '0.0'}">0</h4>
              <small class="text-muted">Moyenne</small>
            </div>
            <div class="col-6">
              <h4 th:text="${stats != null ? stats.passedCount() : 0}">0</h4>
              <small class="text-muted">Réussites</small>
            </div>
            <div class="col-6">
              <h4 th:text="${stats != null ? #numbers.formatDecimal(stats.passRate(), 1, 1) + '%' : '0%'}">0%</h4>
              <small class="text-muted">Taux réussite</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Dernières tentatives -->
      <div class="card">
        <div class="card-header">
          <i class="bi bi-clock-history me-2"></i>Dernières tentatives
        </div>
        <ul class="list-group list-group-flush">
          <li th:if="${#lists.isEmpty(attempts)}" class="list-group-item text-muted">
            Aucune tentative pour le moment.
          </li>
          <li th:each="a, idx : ${attempts}" th:if="${idx.index < 5}" class="list-group-item">
            <div class="d-flex justify-content-between">
              <span>Étudiant #<span th:text="${a.studentId}">1</span></span>
              <span th:classappend="${a.scorePercent >= exam.passThreshold ? 'text-success' : 'text-danger'}"
                    th:text="${a.scorePercent + '%'}">75%</span>
            </div>
            <small class="text-muted" th:text="${#temporals.format(a.startedAt, 'dd/MM HH:mm')}">Date</small>
          </li>
        </ul>
        <div class="card-footer" th:if="${#lists.size(attempts) > 5}">
          <a th:href="@{/prof/exam/{id}/results(id=${exam.id})}" class="btn btn-sm btn-outline-primary w-100">
            Voir tous les résultats
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
</html>
